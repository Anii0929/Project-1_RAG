<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .box { fill: #f0f9ff; stroke: #0369a1; stroke-width: 2; }
      .frontend { fill: #ecfdf5; stroke: #059669; }
      .api { fill: #fef3c7; stroke: #d97706; }
      .rag { fill: #fce7f3; stroke: #be185d; }
      .ai { fill: #ede9fe; stroke: #7c3aed; }
      .tools { fill: #fef2f2; stroke: #dc2626; }
      .arrow { stroke: #374151; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .text { font-family: Arial, sans-serif; font-size: 12px; fill: #374151; }
      .title { font-family: Arial, sans-serif; font-size: 14px; font-weight: bold; fill: #1f2937; }
      .step { font-family: Arial, sans-serif; font-size: 10px; fill: #6b7280; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title" font-size="18">RAG Chatbot Query Processing Flow</text>
  
  <!-- Frontend Layer -->
  <rect x="50" y="60" width="300" height="120" class="box frontend" rx="8"/>
  <text x="200" y="85" text-anchor="middle" class="title">Frontend (JavaScript)</text>
  <text x="70" y="105" class="text">1. User enters query in chat input</text>
  <text x="70" y="125" class="text">2. sendMessage() captures input</text>
  <text x="70" y="145" class="text">3. POST /api/query with query + session_id</text>
  <text x="70" y="165" class="text">4. Show loading animation</text>
  
  <!-- API Layer -->
  <rect x="450" y="60" width="300" height="120" class="box api" rx="8"/>
  <text x="600" y="85" text-anchor="middle" class="title">FastAPI Backend</text>
  <text x="470" y="105" class="text">1. Receive POST at /api/query endpoint</text>
  <text x="470" y="125" class="text">2. Create session if none provided</text>
  <text x="470" y="145" class="text">3. Call rag_system.query()</text>
  <text x="470" y="165" class="text">4. Return QueryResponse JSON</text>
  
  <!-- RAG System Layer -->
  <rect x="850" y="60" width="300" height="120" class="box rag" rx="8"/>
  <text x="1000" y="85" text-anchor="middle" class="title">RAG System</text>
  <text x="870" y="105" class="text">1. Build prompt with query</text>
  <text x="870" y="125" class="text">2. Get conversation history</text>
  <text x="870" y="145" class="text">3. Call ai_generator.generate_response()</text>
  <text x="870" y="165" class="text">4. Update session history</text>
  
  <!-- AI Generator Layer -->
  <rect x="450" y="220" width="300" height="120" class="box ai" rx="8"/>
  <text x="600" y="245" text-anchor="middle" class="title">AI Generator (Claude API)</text>
  <text x="470" y="265" class="text">1. Build system prompt + context</text>
  <text x="470" y="285" class="text">2. Call Anthropic API with tools</text>
  <text x="470" y="305" class="text">3. Handle tool execution if needed</text>
  <text x="470" y="325" class="text">4. Return final response text</text>
  
  <!-- Tool Manager Layer -->
  <rect x="850" y="220" width="300" height="120" class="box tools" rx="8"/>
  <text x="1000" y="245" text-anchor="middle" class="title">Search Tools</text>
  <text x="870" y="265" class="text">1. CourseSearchTool.execute()</text>
  <text x="870" y="285" class="text">2. vector_store.search() with filters</text>
  <text x="870" y="305" class="text">3. Format results with context</text>
  <text x="870" y="325" class="text">4. Store sources for UI</text>
  
  <!-- Vector Store -->
  <rect x="850" y="380" width="300" height="80" class="box" rx="8"/>
  <text x="1000" y="405" text-anchor="middle" class="title">Vector Store (ChromaDB)</text>
  <text x="870" y="425" class="text">• course_catalog: Course metadata</text>
  <text x="870" y="445" class="text">• course_content: Text chunks</text>
  
  <!-- Response Flow -->
  <rect x="50" y="500" width="1100" height="120" class="box frontend" rx="8"/>
  <text x="600" y="525" text-anchor="middle" class="title">Response Flow Back to Frontend</text>
  <text x="70" y="545" class="text">1. Backend returns JSON: {answer, sources, session_id}</text>
  <text x="70" y="565" class="text">2. Frontend removes loading animation</text>
  <text x="70" y="585" class="text">3. addMessage() renders response with markdown parsing</text>
  <text x="70" y="605" class="text">4. Sources displayed in collapsible section, UI re-enabled</text>
  
  <!-- Arrows for main flow -->
  <line x1="350" y1="120" x2="450" y2="120" class="arrow"/>
  <text x="380" y="115" class="step">HTTP POST</text>
  
  <line x1="750" y1="120" x2="850" y2="120" class="arrow"/>
  <text x="780" y="115" class="step">query()</text>
  
  <line x1="1000" y1="180" x2="1000" y2="220" class="arrow"/>
  <text x="1010" y="205" class="step">tools</text>
  
  <line x1="850" y1="280" x2="750" y2="280" class="arrow"/>
  <text x="780" y="275" class="step">results</text>
  
  <line x1="600" y1="220" x2="600" y2="180" class="arrow"/>
  <text x="610" y="205" class="step">call AI</text>
  
  <line x1="1000" y1="340" x2="1000" y2="380" class="arrow"/>
  <text x="1010" y="365" class="step">search</text>
  
  <!-- Return arrows -->
  <line x1="850" y1="140" x2="750" y2="140" class="arrow"/>
  <text x="780" y="155" class="step">response</text>
  
  <line x1="450" y1="140" x2="350" y2="140" class="arrow"/>
  <text x="380" y="155" class="step">JSON</text>
  
  <!-- Tool execution flow -->
  <line x1="750" y1="300" x2="850" y2="300" class="arrow"/>
  <text x="780" y="295" class="step">tool call</text>
  
  <!-- Session Management -->
  <rect x="50" y="380" width="200" height="80" class="box" rx="8"/>
  <text x="150" y="405" text-anchor="middle" class="title">Session Manager</text>
  <text x="70" y="425" class="text">• Conversation history</text>
  <text x="70" y="445" class="text">• Session tracking</text>
  
  <line x1="250" y1="420" x2="450" y2="280" class="arrow" stroke-dasharray="5,5"/>
  <text x="320" y="340" class="step">history</text>
  
</svg>